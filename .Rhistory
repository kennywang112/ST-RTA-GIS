# filter(事故類型及型態子類別名稱 == '追撞') %>%
count(spd_group, 事故類型及型態子類別名稱) %>%
group_by(spd_group) %>%
mutate(prop = n / sum(n)) %>%
ungroup()%>%
filter(事故類型及型態子類別名稱 == '追撞')
ggplot(rear_end, aes(x = 事故類型及型態子類別名稱, y = prop, fill = spd_group)) +
geom_col(position = position_dodge(width = 0.9)) +
labs(x = as_label(spd_group), fill = as_label(事故類型及型態子類別名稱)) +
# theme_minimal()
geom_text(aes(label = n), position = position_dodge(width = 0.9), hjust = -0.1) +
coord_flip()
rear_end
ggplot(rear_end, aes(x = 事故類型及型態子類別名稱, y = prop, fill = acc_buf$spd_group)) +
geom_col(position = position_dodge(width = 0.9)) +
labs(x = as_label(spd_group), fill = as_label(事故類型及型態子類別名稱)) +
# theme_minimal()
geom_text(aes(label = n), position = position_dodge(width = 0.9), hjust = -0.1) +
coord_flip()
ggplot(rear_end, aes(x = 事故類型及型態子類別名稱, y = prop, fill = acc_buf$spd_group)) +
geom_col(position = position_dodge(width = 0.9)) +
labs(x = as_label(acc_buf$spd_group), fill = as_label(事故類型及型態子類別名稱)) +
# theme_minimal()
geom_text(aes(label = n), position = position_dodge(width = 0.9), hjust = -0.1) +
coord_flip()
ggplot(rear_end, aes(x = 事故類型及型態子類別名稱, y = prop, fill = acc_buf$spd_group)) +
geom_col(position = position_dodge(width = 0.9)) +
labs(x = as_label(acc_buf$spd_group), fill = as_label(acc_buf$事故類型及型態子類別名稱)) +
# theme_minimal()
geom_text(aes(label = n), position = position_dodge(width = 0.9), hjust = -0.1) +
coord_flip()
ggplot(rear_end, aes(x = 事故類型及型態子類別名稱, y = prop) +
ggplot(rear_end, aes(x = 事故類型及型態子類別名稱, y = prop)) +
geom_col(position = position_dodge(width = 0.9)) +
labs(x = as_label(acc_buf$spd_group), fill = as_label(acc_buf$事故類型及型態子類別名稱)) +
# theme_minimal()
geom_text(aes(label = n), position = position_dodge(width = 0.9), hjust = -0.1) +
coord_flip()
ggplot(rear_end, aes(x = 事故類型及型態子類別名稱, y = prop)) +
ggplot(rear_end, aes(x = 事故類型及型態子類別名稱, y = prop)) +
geom_col(position = position_dodge(width = 0.9)) +
labs(x = as_label(acc_buf$spd_group), fill = as_label(acc_buf$事故類型及型態子類別名稱)) +
# theme_minimal()
geom_text(aes(label = n), position = position_dodge(width = 0.9), hjust = -0.1) +
coord_flip()
rear_end
rear_end%>%
ggplot() +
geom_col(aes(x = spd_group, y = prop, fill = spd_group))
rear_end%>%
ggplot() +
geom_col(aes(x = spd_group, y = prop, fill = spd_group)) +
labs(x = "Speed Difference Group", fill = "Speed Difference Group")
rear_end%>%
ggplot() +
geom_col(aes(x = spd_group, y = prop, fill = spd_group)) +
labs(x = "Speed Difference Group", fill = "Speed Difference Group") +
# title
ggtitle("Proportion of Rear-end Collisions by Speed Difference Group")
acc_buf
rear_end <- acc_buf%>%
st_drop_geometry()%>%
# filter(事故類型及型態子類別名稱 == '追撞') %>%
count(spd_group, 道路型態子類別名稱) %>%
group_by(spd_group) %>%
mutate(prop = n / sum(n)) %>%
ungroup()%>%
filter(道路型態子類別名稱 %in% c('多岔路', '四岔路'))
# for poster
rear_end <- acc_buf%>%
st_drop_geometry()%>%
# filter(事故類型及型態子類別名稱 == '追撞') %>%
count(spd_group, 事故類型及型態子類別名稱) %>%
group_by(spd_group) %>%
mutate(prop = n / sum(n)) %>%
ungroup()%>%
filter(事故類型及型態子類別名稱 == '追撞')
intersection <- acc_buf%>%
st_drop_geometry()%>%
# filter(事故類型及型態子類別名稱 == '追撞') %>%
count(spd_group, 道路型態子類別名稱) %>%
group_by(spd_group) %>%
mutate(prop = n / sum(n)) %>%
ungroup()%>%
filter(道路型態子類別名稱 %in% c('多岔路', '四岔路'))
intersection
# for poster
rear_end <- acc_buf%>%
st_drop_geometry()%>%
# filter(事故類型及型態子類別名稱 == '追撞') %>%
count(spd_group, 事故類型及型態子類別名稱) %>%
group_by(spd_group) %>%
mutate(prop = n / sum(n)) %>%
ungroup()%>%
filter(事故類型及型態子類別名稱 == '追撞')
# for poster
rear_end <- acc_buf%>%
st_drop_geometry()%>%
# filter(事故類型及型態子類別名稱 == '追撞') %>%
count(spd_group, 事故類型及型態子類別名稱) %>%
group_by(spd_group) %>%
mutate(prop = n / sum(n)) %>%
ungroup()%>%
filter(事故類型及型態子類別名稱 == '追撞')%>%
rename(type = 道路型態子類別名稱)
# for poster
rear_end <- acc_buf%>%
st_drop_geometry()%>%
# filter(事故類型及型態子類別名稱 == '追撞') %>%
count(spd_group, 事故類型及型態子類別名稱) %>%
group_by(spd_group) %>%
mutate(prop = n / sum(n)) %>%
ungroup()%>%
filter(事故類型及型態子類別名稱 == '追撞')%>%
rename(type = 事故類型及型態子類別名稱)
rear_end
intersection <- acc_buf%>%
st_drop_geometry()%>%
# filter(事故類型及型態子類別名稱 == '追撞') %>%
count(spd_group, 道路型態子類別名稱) %>%
group_by(spd_group) %>%
mutate(prop = n / sum(n)) %>%
ungroup()%>%
filter(道路型態子類別名稱 %in% c('多岔路', '四岔路'))%>%
rename(type = 道路型態子類別名稱)
intersection
rear_end%>%rbind(intersection)
full_type <- rbind(rear_end, intersection)
full_type
full_type <- full_type %>%
mutate(spd_group = factor(spd_group, levels = c("No Speed Diff", "Low Speed Diff", "Medium Speed Diff", "High Speed Diff")))
full_type
full_type <- rbind(rear_end, intersection)
full_type
full_type <- full_type %>%
mutate(type = case_when(
type == "追撞" ~ "Rear-end",
type == "四岔路" ~ "4-way Intersection",
type == "多岔路" ~ "Multi-way Intersection",
TRUE ~ type
))
ggplot(full_type, aes(x = spd_group, y = prop, group = type, color = type)) +
geom_line(linewidth = 1.2) +  # 加粗線條
geom_point(size = 3) +        # 加上數據點
scale_color_brewer(palette = "Set1") + # 使用高對比配色
labs(
x = "Speed Difference Group",
y = "Proportion",
color = "Accident/Road Type"
) +
theme_minimal() +
theme(legend.position = "bottom")
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) + # dodge讓長條並排
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal() +
# 加上數值標籤，直接秀出證據
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 3)
ggplot(full_type, aes(x = spd_group, y = prop, group = type, color = type)) +
geom_line(linewidth = 1.2) +  # 加粗線條
geom_point(size = 3) +        # 加上數據點
scale_color_brewer(palette = "Set1") + # 使用高對比配色
labs(
x = "Speed Difference Group",
y = "Proportion",
color = "Accident/Road Type"
) +
theme_minimal() +
theme(legend.position = "bottom")
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) + # dodge讓長條並排
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal() +
# 加上數值標籤，直接秀出證據
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 3)
ggplot(full_type, aes(x = spd_group, y = prop, group = 1)) + # group=1 很重要
geom_col(aes(fill = type), show.legend = FALSE) + # 用長條圖當底
geom_line(color = "black", linewidth = 1) +      # 加上折線強調趨勢
geom_point(size = 2) +
facet_wrap(~type, scales = "free_y") +           # 關鍵：讓Y軸各自獨立！
labs(x = "Speed Difference", y = "Proportion") +
theme_bw()
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) + # dodge讓長條並排
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal() +
# 加上數值標籤，直接秀出證據
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 3)
# 2. 再畫圖 (程式碼跟原本一樣，不用改)
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal() +
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 3)
# 1. 先設定 type 的顯示順序 (關鍵步驟)
full_type <- full_type %>%
mutate(type = factor(type, levels = c("Multi-way Intersection", "Rear-end", "4-way Intersection")))
# 2. 再畫圖 (程式碼跟原本一樣，不用改)
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal() +
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 3)
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal() +
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 3)+
coord_flip()
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal() +
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 3)
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal() +
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 3)+
ggtitle("Proportion of Rear-end Accidents and Intersection Accidents by Speed Difference Group")
install.packages(c("showtext","sysfonts"))
library(showtext)
library(sysfonts)
font_add_google("Noto Sans TC", family = "noto")
showtext_auto()
library(tidyverse)
pairs_annot <- st_read(dsn="./CalculatedData/pairs_annot_all_cities.shp", layer="pairs_annot_all_cities")%>%
st_transform(crs)
library(sf)
library(tmap)
library(tidyverse)
crs_init <- 4326
crs <- 3826
taiwan <- st_read("Data/村(里)界(TWD97經緯度)/VILLAGE_NLSC_1140825.shp")
roads <- st_read(dsn="~/Desktop/RTA-GIS/Data/road/gis_osm_roads_free_1.shp", layer="gis_osm_roads_free_1")
library(tidyverse)
pairs_annot <- st_read(dsn="./CalculatedData/pairs_annot_all_cities.shp", layer="pairs_annot_all_cities")%>%
st_transform(crs)
pairs_annot <- st_join(
pairs_annot,
taiwan%>%
select(COUNTYNAME, TOWNNAME, VILLNAME)%>%
st_transform(crs)
)
pairs_annot%>%summary()
library(tmap)
tmap_mode("view")
tm_shape(pairs_annot) +
tm_dots(size = 0.5, col = "spd_dlt", palette = "Reds", style = "quantile")
filter_lst <- c("新北市", "基隆市", "桃園市", "新竹市", "新竹縣",
"苗栗縣", "臺中市", "嘉義市", "嘉義縣",
"臺南市", "高雄市", "屏東縣", "臺東縣")
specific_pairs_annot <- pairs_annot%>%
# filter(COUNTYNAME %in% filter_lst)%>%
st_transform(crs)
final_data <- combined_data_in_taiwan%>%
# filter(COUNTYNAME %in% filter_lst)%>%
st_as_sf(coords = c("經度", "緯度"), crs = crs_init)%>%
st_transform(crs)
final_data$youbike_100m_count <- case_when(
final_data$youbike_100m_count > 2 ~ 2,
TRUE ~ final_data$youbike_100m_count
)
buf_dist <- 100
acc_buf <- st_buffer(final_data, dist = buf_dist) %>%
st_make_valid() %>%
mutate(buf_id = row_number())
hits <- st_intersects(acc_buf, specific_pairs_annot)
acc_buf$spec_count <- lengths(hits)
# 每個 buffer 的最大 spd_dlt
acc_buf$max_spd_dlt <- sapply(hits, function(ix) {
if(length(ix) == 0) return(NA_real_)
vals <- specific_pairs_annot$spd_dlt[ix]
max(vals, na.rm = TRUE)
})
acc_buf$max_spd_dlt <- ifelse(is.na(acc_buf$max_spd_dlt), 0, acc_buf$max_spd_dlt)
# 確認速差區分
qs <- acc_buf %>%
filter(max_spd_dlt > 0) %>%
pull(max_spd_dlt) %>%
quantile(probs = c(0.33, 0.66), na.rm = TRUE)
qs
acc_buf$spd_group <- case_when(
acc_buf$max_spd_dlt > 50 ~ "High Speed Diff",
acc_buf$max_spd_dlt == 50 ~ "Medium Speed Diff",
acc_buf$max_spd_dlt > 0 & acc_buf$max_spd_dlt < 50 ~ "Low Speed Diff",
TRUE ~ "No Speed Diff"
)
acc_buf$spd_group <- factor(
acc_buf$spd_group,
levels = c("No Speed Diff", "Low Speed Diff", "Medium Speed Diff", "High Speed Diff")
)
acc_buf
#   acc_buf$max_spd_dlt,
#   breaks = 10,
#   include.lowest = TRUE
# )
# acc_buf$spd_group <- cut(
#   acc_buf$max_spd_dlt,
#   # breaks = c(-1, 0, 20, 40, 60, 80, 100, 110),
#   breaks = c(-1, 0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110),
#   include.lowest = TRUE,
# )
acc_buf$spd_group%>%table()
acc_buf%>%
filter(max_spd_dlt > 0)%>%
ggplot() +
geom_bar(aes(x = max_spd_dlt), fill = "steelblue", color = "black")
# 有無設施下、有高素差和無高素差有沒有不同型態的道路事故
# 以速限差為主軸去分割
acc_buf%>%colnames()
plot_func <- function(data, main_col, target) {
main_col_q <- enquo(main_col)
target_q  <- enquo(target)
ratio_table <- data %>%
count(!!main_col_q, !!target_q) %>%
group_by(!!main_col_q) %>%
mutate(prop = n / sum(n)) %>%
ungroup()
plt <- ggplot(ratio_table, aes(x = !!target_q, y = prop, fill = !!main_col_q)) +
geom_col(position = position_dodge(width = 0.9)) +
labs(x = as_label(target_q), fill = as_label(main_col_q)) +
# theme_minimal()
geom_text(aes(label = n), position = position_dodge(width = 0.9), hjust = -0.1) +
coord_flip()
# return(ratio_table)
return(plt)
}
# for poster
rear_end <- acc_buf%>%
st_drop_geometry()%>%
# filter(事故類型及型態子類別名稱 == '追撞') %>%
count(spd_group, 事故類型及型態子類別名稱) %>%
group_by(spd_group) %>%
mutate(prop = n / sum(n)) %>%
ungroup()%>%
filter(事故類型及型態子類別名稱 == '追撞')%>%
rename(type = 事故類型及型態子類別名稱)
intersection <- acc_buf%>%
st_drop_geometry()%>%
# filter(事故類型及型態子類別名稱 == '追撞') %>%
count(spd_group, 道路型態子類別名稱) %>%
group_by(spd_group) %>%
mutate(prop = n / sum(n)) %>%
ungroup()%>%
filter(道路型態子類別名稱 %in% c('多岔路', '四岔路'))%>%
rename(type = 道路型態子類別名稱)
full_type <- rbind(rear_end, intersection)
full_type <- full_type %>%
mutate(type = case_when(
type == "追撞" ~ "Rear-end",
type == "四岔路" ~ "4-way Intersection",
type == "多岔路" ~ "Multi-way Intersection",
TRUE ~ type
))
full_type <- full_type %>%
mutate(type = factor(type, levels = c("Multi-way Intersection", "Rear-end", "4-way Intersection")))
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal() +
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 3)+
ggtitle("Proportion of Rear-end Accidents and Intersection Accidents by Speed Difference Group")
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal(base_size = 20) +
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 3)
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal(base_size = 18) +
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 3)
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal(base_size = 18) +
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 3)+
coord_flip()
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal(base_size = 18) +
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 3)
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal(base_size = 18) +
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 6)
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal(base_size = 18) +
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 6)+
coord_flip()
ggplot(full_type, aes(x = spd_group, y = prop, fill = type)) +
geom_col(position = "dodge", width = 0.7) +
scale_fill_brewer(palette = "Set2") +
labs(
x = "Speed Difference Group",
y = "Proportion",
fill = "Accident/Road Type"
) +
theme_minimal(base_size = 18) +
geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
position = position_dodge(width = 0.7),
vjust = -0.5, size = 6)
