ungroup()%>%
filter(!is.na(!!target_q))
plt <- ggplot(ratio_table, aes(x = reorder(new_label, ifelse(!!main_col_q == "Speed Diff", prop, 0)), y = prop, fill = !!main_col_q)) +
geom_col() +
coord_flip() +
scale_y_continuous(labels = function(x) scales::percent(abs(x))) +
scale_fill_manual(values = c("No Speed Diff" = "#4682B4", "Speed Diff" = "#B22222"))+
labs(x = as_label(target_q), fill = as_label(main_col_q))+
theme_minimal(base_size = 20)
}
return(plt)
}
lst <- c('道路類別-第1當事者-名稱', '道路型態大類別名稱', '道路型態子類別名稱', '事故位置大類別名稱', '事故位置子類別名稱', '號誌-號誌種類名稱',
'號誌-號誌動作名稱', '車道劃分設施-分向設施大類別名稱', '車道劃分設施-分向設施子類別名稱', '車道劃分設施-分道設施-快車道或一般車道間名稱',
'車道劃分設施-分道設施-快慢車道間名稱', '車道劃分設施-分道設施-路面邊線名稱', '事故類型及型態大類別名稱', '事故類型及型態子類別名稱', '肇因研判大類別名稱-主要',
'當事者區分-類別-大類別名稱-車種', '當事者行動狀態大類別名稱', '車輛撞擊部位大類別名稱-最初', '肇因研判大類別名稱-個別', '當事者區分-類別-子類別名稱-車種',
'道路型態子類別名稱', 'youbike_100m_count')
plot_func(acc_buf, spd_group, 道路型態大類別名稱, type='percent')
plot_func(acc_buf, spd_group, 事故類型及型態大類別名稱, type='percent')
for (i in lst) {
col_sym <- sym(i)
p <- plot_func(acc_buf, spd_group, !!col_sym, type='percent')
ggsave(paste0("Layouts/speed_diff_", i, ".png"), plot = p, width = 8, height = 6, dpi = 300)
}
plot_func <- function(data, main_col, target, type='origin') {
main_col_q <- enquo(main_col)
target_q  <- enquo(target)
if (type == 'origin') {
ratio_table <- data %>%
st_drop_geometry() %>%
count(!!main_col_q, !!target_q) %>%
group_by(!!main_col_q) %>%
mutate(prop = n / sum(n)) %>%
ungroup()
plt <- ggplot(ratio_table, aes(x = !!target_q, y = prop, fill = !!main_col_q)) +
geom_col(position = position_dodge(width = 0.9)) +
labs(x = as_label(target_q), fill = as_label(main_col_q)) +
# theme_minimal()
geom_text(aes(label = n), position = position_dodge(width = 0.9), hjust = -0.1) +
coord_flip()
}
else if (type == 'percent') {
ratio_table <- data %>%
st_drop_geometry() %>%
add_count(!!target_q, name = "total_n") %>%
mutate(new_label = paste0(!!target_q, "\n(N=", total_n, ")"))%>%
count(!!target_q, !!main_col_q, total_n, new_label) %>%
group_by(!!target_q) %>%
mutate(prop = n / sum(n)) %>%
ungroup()%>%
filter(!is.na(!!target_q))
plt <- ggplot(ratio_table, aes(x = reorder(new_label, ifelse(!!main_col_q == "Speed Diff", prop, 0)), y = prop, fill = !!main_col_q)) +
geom_col() +
coord_flip() +
scale_y_continuous(labels = function(x) scales::percent(abs(x))) +
scale_fill_manual(values = c("No Speed Diff" = "#4682B4", "Speed Diff" = "#B22222"))+
labs(x = as_label(target_q), fill = as_label(main_col_q))+
theme_minimal(base_size = 15)
}
return(plt)
}
lst <- c('道路類別-第1當事者-名稱', '道路型態大類別名稱', '道路型態子類別名稱', '事故位置大類別名稱', '事故位置子類別名稱', '號誌-號誌種類名稱',
'號誌-號誌動作名稱', '車道劃分設施-分向設施大類別名稱', '車道劃分設施-分向設施子類別名稱', '車道劃分設施-分道設施-快車道或一般車道間名稱',
'車道劃分設施-分道設施-快慢車道間名稱', '車道劃分設施-分道設施-路面邊線名稱', '事故類型及型態大類別名稱', '事故類型及型態子類別名稱', '肇因研判大類別名稱-主要',
'當事者區分-類別-大類別名稱-車種', '當事者行動狀態大類別名稱', '車輛撞擊部位大類別名稱-最初', '肇因研判大類別名稱-個別', '當事者區分-類別-子類別名稱-車種',
'道路型態子類別名稱', 'youbike_100m_count')
for (i in lst) {
col_sym <- sym(i)
p <- plot_func(acc_buf, spd_group, !!col_sym, type='percent')
ggsave(paste0("Layouts/speed_diff_", i, ".png"), plot = p, width = 8, height = 6, dpi = 300)
}
plot_func <- function(data, main_col, target, type='origin') {
main_col_q <- enquo(main_col)
target_q  <- enquo(target)
if (type == 'origin') {
ratio_table <- data %>%
st_drop_geometry() %>%
count(!!main_col_q, !!target_q) %>%
group_by(!!main_col_q) %>%
mutate(prop = n / sum(n)) %>%
ungroup()
plt <- ggplot(ratio_table, aes(x = !!target_q, y = prop, fill = !!main_col_q)) +
geom_col(position = position_dodge(width = 0.9)) +
labs(x = as_label(target_q), fill = as_label(main_col_q)) +
# theme_minimal()
geom_text(aes(label = n), position = position_dodge(width = 0.9), hjust = -0.1) +
coord_flip()
}
else if (type == 'percent') {
ratio_table <- data %>%
st_drop_geometry() %>%
add_count(!!target_q, name = "total_n") %>%
mutate(new_label = paste0(!!target_q, "(N=", total_n, ")"))%>%
count(!!target_q, !!main_col_q, total_n, new_label) %>%
group_by(!!target_q) %>%
mutate(prop = n / sum(n)) %>%
ungroup()%>%
filter(!is.na(!!target_q))
plt <- ggplot(ratio_table, aes(x = reorder(new_label, ifelse(!!main_col_q == "Speed Diff", prop, 0)), y = prop, fill = !!main_col_q)) +
geom_col() +
coord_flip() +
scale_y_continuous(labels = function(x) scales::percent(abs(x))) +
scale_fill_manual(values = c("No Speed Diff" = "#4682B4", "Speed Diff" = "#B22222"))+
labs(x = as_label(target_q), fill = as_label(main_col_q))+
theme_minimal(base_size = 15)
}
return(plt)
}
plot_func(acc_buf, spd_group, 事故類型及型態大類別名稱, type='percent')
for (i in lst) {
col_sym <- sym(i)
p <- plot_func(acc_buf, spd_group, !!col_sym, type='percent')
ggsave(paste0("Layouts/speed_diff_", i, ".png"), plot = p, width = 8, height = 6, dpi = 300)
}
pairs_annot
acc_buf
acc_buf$`肇因研判子類別名稱-主要`
source('./utils')
source('./utils.R')
source('utils.R')
source('./utils.R')
source('utils.R')
source('../utils.R')
cause_mapping_list <- list(
# 不專心
Distraction = c(
"起步時未注意安全",
"恍神、緊張、心不在焉分心駕駛",
"觀看其他事故、活動、道路環境或車外資訊分心駕駛",
"飲食、抽(點)菸、拿(撿)物品分心駕駛",
"穿越道路未注意左右來車",
"橫越道路不慎",
"乘客、車上動(生)物干擾分心駕駛",
"操作、觀看行車輔助或娛樂性顯示設備",
"使用手持行動電話"
),
# 錯誤決策
Decision = c(
"違反閃光號誌",
"車輛未依規定暫停讓行人先行",
"其他不當駕車行為",
"闖紅燈左轉(或迴轉)",
"闖紅燈直行",
"無號誌路口，轉彎車未讓直行車先行",
"左轉彎未依規定",
"逆向行駛",
"無號誌路口，左方車未讓右方車先行",
"右轉彎未依規定",
"未依標誌或標線穿越道路",
"未依規定減速",
"閃避不當(慎)",
"有號誌路口，轉彎車未讓直行車先行",
"違反禁止超車標誌(線)",
"變換車道不當",
"倒車未依規定",
"違反二段式左(右)轉標誌(線)",
"無號誌路口，支線道未讓幹線道先行",
"其他未依規定讓車",
"未保持行車安全間隔",
"未保持行車安全距離",
"違反其他標誌(線)禁制",
"迴轉未依規定",
"未依號誌或手勢指揮(示)穿越道路",
"超速駕駛",
"違反其他號誌",
"無號誌路口，少線道未讓多線道先行",
"違規超車",
"闖紅燈右轉",
"違反禁止左轉、右轉標誌",
"未避讓緊急任務車輛",
"未避讓(跟隨、併駛、超車)消防、救護、警備、工程救險車、毒性化學物質災害事故應變車等執行緊急任務車",
"未靠右行駛",
"違反禁止變換車道標線",
"爭(搶)道行駛",
"未依規定行走地下道、天橋穿越道路",
"多車道迴轉，未先駛入內側車道",
"違反車輛專用標誌(線)",
"違反遵行方向標誌(線)",
"未依規定使用燈光",
"違反禁止迴轉或迴車標誌",
"行經圓環未依規定讓車",
"未遵守依法令授權交通指揮人員之指揮",
"山路會車，靠山壁車未讓外緣車先行",
"違反行人專用標誌(線)",
"違反車輛改道標誌",
"違反禁止會車標誌",
"車輛或機械操作不當(慎)",
"方向不定(不包括危險駕車)",
"搶(闖)越平交道",
"違反禁行車種標誌(字)",
"違反禁止進入標誌",
"違反禁止各種車輛進入標誌"
),
# 違規姿態 / 停車
Posture = c(
"違規(臨時)停車",
"開啟或關閉車門不當",
"未待乘客安全上下而開車",
"車輛拋錨未採安全措施",
"發生事故後，未採取安全措施",
"暗處停車無燈光、標識",
"車輛未停妥滑動致生事故",
"停車操作時未注意安全",
"上下車輛時未注意安全",
"未待車輛停妥而上下車"
),
# 酒駕 / 疲勞
Driver_Impairment = c(
"患病或服用藥物(疲勞)駕駛",
"酒醉(後)駕駛",
"打瞌睡或疲勞駕駛",
"吸食違禁物駕駛",
"打瞌睡或疲勞駕駛(包括連續駕車8小時)"
),
# 其他
Other = c(
"在道路上嬉戲或奔走不定",
"其他引起事故之疏失或行為",
"峻狹坡路會車，下坡車未讓上坡車先行",
"使用車輛自動駕駛或先進駕駛輔助系統設備(裝置)不符規定",
"使用自動駕駛或先進駕駛輔助系統設備不符規定",
"乘坐不當(慎)",
"危險駕駛"
),
# 車輛
Vehicle = c(
"車輪脫落或輪胎爆裂",
"車輛零件脫落",
"其他機件失靈或故障",
"煞車失靈或故障",
"裝載貨物不穩妥",
"裝載未盡安全措施",
"物品滾(滑行)或飛(掉)落",
"車輛附屬機具或車門未盡安全措施",
"方向操縱系統故障",
"超載人員",
"載運貨物超重",
"裝卸貨物不當",
"其他裝載不當",
"燈光系統故障",
"載運貨物超長、寬、高",
"夜間行駛無燈光設備"
),
# 環境
Environmental = c(
"在道路上工作之人員未設適當標識",
"因光線、視線遮蔽致生事故",
"道路設施、植栽或其他裝置倒塌或掉落",
"施工安全防護措施未完善",
"平交道看守疏失或未放柵欄",
"強風、暴雨、濃霧(煙)",
"動物竄出",
"路況危險無安全(警告)設施",
"未依法令授權指揮交通或指揮不當",
"道路設施(備)、植栽或其他裝置，倒塌或掉(斷)落",
"物品(件)滾(滑行)或飛(掉)落",
"其他交通管制不當",
"施工安全防護措施未依規定或未盡完善(備)"
),
# 未發現 / 不明
Unidentified = c(
"尚未發現肇事因素",
"相關跡證不足且無具體影像紀錄",
"肇事逃逸未查獲，無法查明肇因",
"事故發生時當事者逕自離開現場",
"被車輛輾壓之不明物體彈飛",
"相關跡證不足且無具體影像紀錄，當事人各執一詞，經分析後無法釐清肇事原因"
)
)
cause_lookup_df <- stack(acc_buf) %>%
rename(cause_detail = values, cause_category = ind)
cause_lookup_df <- acc_buf%>%
st_drop_geometry()%>%
stack() %>%
rename(cause_detail = values, cause_category = ind)
cause_lookup_df
cause_lookup_df$cause_detail%>%unique()
cause_lookup_df <- stack(cause_mapping_list) %>%
rename(cause_detail = values, cause_category = ind)
cause_lookup_df
df_final <- acc_buf%>%
st_drop_geometry()%>%
left_join(cause_lookup_df, by = c("accident_cause" = "cause_detail"))
df_final <- acc_buf%>%
st_drop_geometry()%>%
left_join(cause_lookup_df, by = c(`肇因研判子類別名稱-主要` = "cause_detail"))
df_final
df_final$cause_detail%>%unique()
df_final$cause_detail
View(df_final)
df_final$cause_detail
df_final$cause_category
df_final$cause_category%<%unique()
df_final$cause_category%>%unique()
## 以有無速差為底
ggplot(rt, aes(x = reorder(道路型態子類別名稱, ifelse(spd_group == "Speed Diff", prop, 0)),
y = prop, fill = spd_group)) +
geom_col() +
coord_flip() +
scale_y_continuous(labels = function(x) scales::percent(abs(x))) +
scale_fill_manual(values = c("No Speed Diff" = "#4682B4",
"Speed Diff" = "#B22222"))
## 以有無速差為底
ggplot(rt, aes(x = reorder(cause_category, ifelse(spd_group == "Speed Diff", prop, 0)),
y = prop, fill = spd_group)) +
geom_col() +
coord_flip() +
scale_y_continuous(labels = function(x) scales::percent(abs(x))) +
scale_fill_manual(values = c("No Speed Diff" = "#4682B4",
"Speed Diff" = "#B22222"))
plot_func(df_final, spd_group, cause_category, type='percent')
plot_func(acc_buf, spd_group, 肇因研判子類別名稱-主要, type='percent')
plot_func(acc_buf, spd_group, '肇因研判子類別名稱-主要', type='percent')
plot_func(acc_buf, spd_group, sym('肇因研判子類別名稱-主要'), type='percent')
Q
sym('肇因研判子類別名稱-主要'),
sym('肇因研判子類別名稱-主要')
plot_func(acc_buf, spd_group, `肇因研判子類別名稱-主要`, type='percent')
plot_func(df_final, spd_group, cause_category, type='percent')
acc_buf$`肇因研判子類別名稱-主要`
plot_func(acc_buf, spd_group, 車道劃分設施-分向設施子類別名稱, type='percent')
plot_func(acc_buf, spd_group, `車道劃分設施-分向設施子類別名稱`, type='percent')
library(tidyverse)
library(MapperAlgo)
library(igraph)
library(networkD3)
library(ggraph)
library(tidygraph)
filter_data <- read_csv("../ST-RTA/ComputedDataV2/ForModel/filtered_dataV1.csv")
filter_data%>%summary()
source('../TDA-R/MapperAlgo/R/Plotter.R')
all_features <- read_csv("../ST-RTA/ComputedDataV2/ForModel/all_featuresV1.csv")
all_features$hotspot <- case_when(
all_features$hotspot == 'Not Significant' ~ 0,
TRUE ~ 1
)
all_features$`號誌-號誌種類名稱_行車管制號誌` <- ifelse(all_features$`號誌-號誌種類名稱_行車管制號誌` > 0, 1, 0)
table(all_features[, c("hotspot", "號誌-號誌種類名稱_行車管制號誌")])
all_features <- all_features%>%
mutate(
bn_feature = ifelse(
(
(
(道路型態大類別名稱_單路部分 > 0) |
(道路型態大類別名稱_其他 > 0) |
(道路型態大類別名稱_圓環廣場 > 0) |
(道路型態大類別名稱_平交道 > 0) |
(道路型態大類別名稱_交岔路 > 0)
) &
(
(`號誌-號誌種類名稱_行車管制號誌(附設行人專用號誌)` > 0) |
(`號誌-號誌種類名稱_行車管制號誌` > 0) |
(`號誌-號誌種類名稱_閃光號誌` > 0) |
(`號誌-號誌種類名稱_無號誌` > 0)
) &
(
(`道路類別-第1當事者-名稱_市區道路` > 0)
) &
(
(original_speed < 60)
) &
(
(youbike_100m_count_mean > 0)
)
),
1,
0
)
)
all_features$bn_feature%>%table()
time_taken <- system.time({
Mapper <- MapperAlgo(
filter_values = filter_data[,1:5],
percent_overlap = 0.5,
# methods = "dbscan",
# method_params = list(eps = 0.3, minPts = 3),
# methods = "hierarchical",
# method_params = list(num_bins_when_clustering = 10, method = 'ward.D2'),
methods = "kmeans",
method_params = list(max_kmeans_clusters = 5),
# methods = "pam",
# method_params = list(num_clusters = 2),
cover_type = 'stride',
# intervals = 4,
interval_width = 0.7,
num_cores = 12
)
})
Mapper
View(Mapper)
library(jsonlite)
mapperoutput <- Mapper
export_data <- list(
adjacency = mapperoutput$adjacency,
num_vertices = mapperoutput$num_vertices,
level_of_vertex = mapperoutput$level_of_vertex,
points_in_vertex = mapperoutput$points_in_vertex,
original_data = filter_data
)
write(toJSON(export_data, auto_unbox = TRUE), "~/desktop/my_mapper_graph.json")
library(jsonlite)
# 準備輸出資料 (假設您的結果叫 mapperoutput，原始資料叫 filter_data)
export_data <- list(
adjacency = mapperoutput$adjacency,
num_vertices = mapperoutput$num_vertices,
level_of_vertex = mapperoutput$level_of_vertex,
points_in_vertex = mapperoutput$points_in_vertex,
original_data = filter_data  # 記得放入原始資料以顯示顏色
)
# 儲存為 JSON
write(toJSON(export_data, auto_unbox = TRUE), "my_mapper_graph.json")
# 儲存為 JSON
write(toJSON(export_data, auto_unbox = TRUE), "~/desktop/my_mapper_graph.json")
filter_data
urban
source('../TDA-R/MapperAlgo/R/CPEmbedding.R')
urban <- CPEmbedding(Mapper, all_features,
columns = list("hotspot", "號誌-號誌種類名稱_行車管制號誌"),
a_level = 1, b_level = 1)
urban
MapperPlotter(Mapper,
label=urban,
data=filter_data,
type="forceNetwork",
avg=TRUE,
use_embedding=TRUE)
MapperPlotter(Mapper,
label=all_features$bn_feature,
data=filter_data,
type="forceNetwork",
avg=TRUE,
use_embedding=FALSE)
urban
filter_data
filter_data
all_features
urban
all_features
# 準備輸出資料 (假設您的結果叫 mapperoutput，原始資料叫 filter_data)
export_data <- list(
adjacency = mapperoutput$adjacency,
num_vertices = mapperoutput$num_vertices,
level_of_vertex = mapperoutput$level_of_vertex,
points_in_vertex = mapperoutput$points_in_vertex,
original_data = all_features  # 記得放入原始資料以顯示顏色
)
# 儲存為 JSON
write(toJSON(export_data, auto_unbox = TRUE), "~/desktop/my_mapper_graph.json")
all_features
# 儲存為 JSON
# 儲存為 JSON
write(toJSON(export_data, auto_unbox = TRUE), "~/desktop/my_mapper_graph.json")
all_features
export_data
all_features
# 準備輸出資料 (假設您的結果叫 mapperoutput，原始資料叫 filter_data)
export_data <- list(
adjacency = mapperoutput$adjacency,
num_vertices = mapperoutput$num_vertices,
level_of_vertex = mapperoutput$level_of_vertex,
points_in_vertex = mapperoutput$points_in_vertex,
original_data = as.data.frame(all_features)  # 記得放入原始資料以顯示顏色
)
# 儲存為 JSON
write(toJSON(export_data, auto_unbox = TRUE), "~/desktop/my_mapper_graph.json")
as.data.frame(all_features)
# 準備輸出資料 (假設您的結果叫 mapperoutput，原始資料叫 filter_data)
export_data <- list(
adjacency = mapperoutput$adjacency,
num_vertices = mapperoutput$num_vertices,
level_of_vertex = mapperoutput$level_of_vertex,
points_in_vertex = mapperoutput$points_in_vertex,
original_data = as.data.frame(all_features)  # 記得放入原始資料以顯示顏色
)
export_data
# 儲存為 JSON
# 儲存為 JSON
write(toJSON(export_data, auto_unbox = TRUE), "~/desktop/my_mapper_graph.json")
MapperPlotter(Mapper,
label=all_features$hotspot,
data=filter_data,
type="ggraph",
avg=TRUE,
use_embedding=FALSE)
urban
urban
# 準備輸出資料 (假設您的結果叫 mapperoutput，原始資料叫 filter_data)
export_data <- list(
adjacency = mapperoutput$adjacency,
num_vertices = mapperoutput$num_vertices,
level_of_vertex = mapperoutput$level_of_vertex,
points_in_vertex = mapperoutput$points_in_vertex,
original_data = urban  # 記得放入原始資料以顯示顏色
)
# 儲存為 JSON
write(toJSON(export_data, auto_unbox = TRUE), "~/desktop/my_mapper_graph.json")
MapperPlotter(Mapper,
label=urban,
data=filter_data,
type="forceNetwork",
avg=TRUE,
use_embedding=TRUE)
# 準備輸出資料 (假設您的結果叫 mapperoutput，原始資料叫 filter_data)
export_data <- list(
adjacency = mapperoutput$adjacency,
num_vertices = mapperoutput$num_vertices,
level_of_vertex = mapperoutput$level_of_vertex,
points_in_vertex = mapperoutput$points_in_vertex,
original_data = as.data.frame(all_features)  # 記得放入原始資料以顯示顏色
)
# 儲存為 JSON
write(toJSON(export_data, auto_unbox = TRUE), "~/desktop/my_mapper_graph.json")
