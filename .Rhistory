title = "Local Morans I",
border.alpha = 0,
lwd = 0)+
tm_shape(boundary) +
tm_borders(col = "black", lwd = 0.1) +
add_map_decorations()
morans_i%>%
filter((quadrant %in% c("High-Low", "Low-High")) || (num_accidents > 0))%>%
tm_shape() +
tm_fill(col = "quadrant",
palette = quadrant_labels,
title = "Local Morans I",
border.alpha = 0,
lwd = 0)+
tm_shape(boundary) +
tm_borders(col = "black", lwd = 0.1) +
add_map_decorations()
morans_i%>%
filter((quadrant %in% c("High-Low", "Low-High")) | (num_accidents > 0))%>%
tm_shape() +
tm_fill(col = "quadrant",
palette = quadrant_labels,
title = "Local Morans I",
border.alpha = 0,
lwd = 0)+
tm_shape(boundary) +
tm_borders(col = "black", lwd = 0.1) +
add_map_decorations()
morans_i%>%
filter((quadrant %in% c("High-Low", "Low-High")) & (num_accidents > 0))%>%
tm_shape() +
tm_fill(col = "quadrant",
palette = quadrant_labels,
title = "Local Morans I",
border.alpha = 0,
lwd = 0)+
tm_shape(boundary) +
tm_borders(col = "black", lwd = 0.1) +
add_map_decorations()
morans_i%>%filter((quadrant %in% c("High-Low", "Low-High"))
morans_i%>%filter((quadrant %in% c("High-Low", "Low-High")))
morans_i%>%filter((quadrant %in% c("High-Low", "Low-High")))
morans_i%>%filter((quadrant %in% c("High-Low")))
morans_i%>%filter((quadrant %in% c("High-Low")))%>%
filter(num_accidents > 0))
morans_i%>%filter((quadrant %in% c("High-Low")))%>%
filter(num_accidents > 0)
morans_i%>%
# filter((quadrant %in% c("High-Low", "Low-High")) & (num_accidents > 0))%>%
filter(num_accidents > 0)%>%
tm_shape() +
tm_fill(col = "quadrant",
palette = quadrant_labels,
title = "Local Morans I",
border.alpha = 0,
lwd = 0)+
tm_shape(boundary) +
tm_borders(col = "black", lwd = 0.1) +
add_map_decorations()
county <- st_read(dsn="~/Desktop/RTA-GIS/Data/縣市界線(TWD97經緯度)/COUNTY_MOI_1090820.shp", layer="COUNTY_MOI_1090820")
# county <- st_read(dsn="~/Desktop/ST-RTA/Data/OFiles_9e222fea-bafb-4436-9b17-10921abc6ef2/TOWN_MOI_1140318.shp", layer="TOWN_MOI_1140318")
ftown <- c('蘭嶼鄉', '綠島鄉', '琉球鄉')
library(tmap)
library(leaflet)
library(sp)
library(sf)
library(raster)
library(adehabitatHR)
library(tidyverse)
county <- st_read(dsn="~/Desktop/RTA-GIS/Data/縣市界線(TWD97經緯度)/COUNTY_MOI_1090820.shp", layer="COUNTY_MOI_1090820")
# county <- st_read(dsn="~/Desktop/ST-RTA/Data/OFiles_9e222fea-bafb-4436-9b17-10921abc6ef2/TOWN_MOI_1140318.shp", layer="TOWN_MOI_1140318")
combined_data <- read_csv("~/Desktop/ST-RTA/ComputedDataV2/Accident/combined_data_in_taiwan.csv")
combined_data <- st_as_sf(combined_data, coords = c("經度", "緯度"), crs = 4326)%>%
st_transform(st_crs(county))
roundabout <- combined_data%>%
filter(道路型態子類別名稱 == '圓環')%>%
st_transform(st_crs(county))
get_join <- function(sdf) {
grouped_data <- sdf%>%
st_drop_geometry() %>%
# group_by(COUNTYNAME, TOWNNAME)%>%
group_by(COUNTYNAME)%>%
summarise(count = n())%>%
arrange(desc(count))
# join county with grouped_data
county_count <- county %>%
# left_join(grouped_data, by = c("COUNTYNAME", "TOWNNAME"))%>%
left_join(grouped_data, by = c("COUNTYNAME"))%>%
replace_na(list(count = 0L))
# mutate(count = dplyr::coalesce(count, 0L))
return(county_count)
}
# county <- st_read(dsn="~/Desktop/ST-RTA/Data/OFiles_9e222fea-bafb-4436-9b17-10921abc6ef2/TOWN_MOI_1140318.shp", layer="TOWN_MOI_1140318")
combined_data <- read_csv("~/Desktop/ST-RTA/ComputedDataV2/Accident/combined_data_in_taiwan.csv")
combined_data
combined_data <- st_as_sf(combined_data, coords = c("經度", "緯度"), crs = 4326)%>%
st_transform(st_crs(county))
county <- st_read(dsn="~/Desktop/RTA-GIS/Data/縣市界線(TWD97經緯度)/COUNTY_MOI_1090820.shp", layer="COUNTY_MOI_1090820")
boundary <- st_read('../ST-RTA/ComputedDataV2/Taiwan/taiwan.shp')
combined_data <- st_as_sf(combined_data, coords = c("經度", "緯度"), crs = 4326)%>%
st_transform(st_crs(boundary))
roundabout <- combined_data%>%
filter(道路型態子類別名稱 == '圓環')%>%
st_transform(st_crs(county))
grouped_data <- sdf%>%
st_drop_geometry() %>%
# group_by(COUNTYNAME, TOWNNAME)%>%
group_by(COUNTYNAME)%>%
summarise(count = n())%>%
arrange(desc(count))
get_join <- function(sdf) {
grouped_data <- sdf%>%
st_drop_geometry() %>%
# group_by(COUNTYNAME, TOWNNAME)%>%
group_by(COUNTYNAME)%>%
summarise(count = n())%>%
arrange(desc(count))
# join county with grouped_data
county_count <- county %>%
# left_join(grouped_data, by = c("COUNTYNAME", "TOWNNAME"))%>%
left_join(grouped_data, by = c("COUNTYNAME"))%>%
replace_na(list(count = 0L))
# mutate(count = dplyr::coalesce(count, 0L))
return(county_count)
}
new_county <- get_join(roundabout)
roundabout <- combined_data%>%
filter(道路型態子類別名稱 == '圓環')%>%
st_transform(st_crs(boundary))
get_join <- function(sdf) {
grouped_data <- sdf%>%
st_drop_geometry() %>%
# group_by(COUNTYNAME, TOWNNAME)%>%
group_by(COUNTYNAME)%>%
summarise(count = n())%>%
arrange(desc(count))
# join county with grouped_data
county_count <- county %>%
# left_join(grouped_data, by = c("COUNTYNAME", "TOWNNAME"))%>%
left_join(grouped_data, by = c("COUNTYNAME"))%>%
replace_na(list(count = 0L))
# mutate(count = dplyr::coalesce(count, 0L))
return(county_count)
}
new_county <- get_join(roundabout)
boundary
get_join <- function(sdf) {
grouped_data <- sdf%>%
st_drop_geometry() %>%
# group_by(COUNTYNAME, TOWNNAME)%>%
group_by(COUNTYNAME)%>%
summarise(count = n())%>%
arrange(desc(count))
# join county with grouped_data
county_count <- boundary %>%
# left_join(grouped_data, by = c("COUNTYNAME", "TOWNNAME"))%>%
left_join(grouped_data, by = c("COUNTYNAME"))%>%
replace_na(list(count = 0L))
# mutate(count = dplyr::coalesce(count, 0L))
return(county_count)
}
boundary
new_county <- get_join(roundabout)
new_county
tmap_mode("plot")
tm_basemap("CartoDB.Positron") +
tm_shape(new_county) +
tm_polygons(
col = "count",
style = "fixed",
# breaks = c(0, 1000, 5000, 10000, 20000),
# breaks = c(0, 10, 20, 30, 40, 50),
breaks = c(0, 50, 100, 150, 200, 250, 300),
palette = "viridis",
border.col = "white",
lwd = 0.3,
title = "Accidents count",
) +
# tm_text("TOWNID", size = 0.3, col = "black") +
tm_compass(position = c("right","top")) +
tm_scale_bar(position = c("right","top")) +
tm_view()
new_county <- get_join(combined_data)
new_county
tmap_mode("plot")
tm_basemap("CartoDB.Positron") +
tm_shape(new_county) +
tm_polygons(
col = "count",
style = "fixed",
breaks = c(0, 1000, 5000, 10000, 20000),
palette = "viridis",
border.col = "white",
lwd = 0.3,
title = "Accidents count",
) +
# tm_text("TOWNID", size = 0.3, col = "black") +
tm_compass(position = c("right","top")) +
tm_scale_bar(position = c("right","top")) +
tm_view()
tm_basemap("CartoDB.Positron") +
tm_shape(new_county) +
tm_polygons(
col = "count",
# style = "fixed",
# breaks = c(0, 1000, 5000, 10000, 20000),
palette = "viridis",
border.col = "white",
lwd = 0.3,
title = "Accidents count",
) +
# tm_text("TOWNID", size = 0.3, col = "black") +
tm_compass(position = c("right","top")) +
tm_scale_bar(position = c("right","top")) +
tm_view()
combined_data
boundary
get_join <- function(sdf) {
grouped_data <- sdf%>%
st_drop_geometry() %>%
# group_by(COUNTYNAME, TOWNNAME)%>%
group_by(TOWNNAME)%>%
summarise(count = n())%>%
arrange(desc(count))
# join county with grouped_data
county_count <- boundary %>%
# left_join(grouped_data, by = c("COUNTYNAME", "TOWNNAME"))%>%
left_join(grouped_data, by = c("TOWNNAME"))%>%
replace_na(list(count = 0L))
# mutate(count = dplyr::coalesce(count, 0L))
return(county_count)
}
new_county <- get_join(combined_data)
tmap_mode("plot")
tm_basemap("CartoDB.Positron") +
tm_shape(new_county) +
tm_polygons(
col = "count",
# style = "fixed",
# breaks = c(0, 1000, 5000, 10000, 20000),
palette = "viridis",
border.col = "white",
lwd = 0.3,
title = "Accidents count",
) +
# tm_text("TOWNID", size = 0.3, col = "black") +
tm_compass(position = c("right","top")) +
tm_scale_bar(position = c("right","top")) +
tm_view()
tm_basemap("CartoDB.Positron") +
tm_shape(new_county) +
tm_polygons(
col = "count",
# style = "fixed",
breaks = c(0, 1000, 5000, 10000, 20000, 50000),
palette = "viridis",
border.col = "white",
lwd = 0.3,
title = "Accidents count",
) +
# tm_text("TOWNID", size = 0.3, col = "black") +
tm_compass(position = c("right","top")) +
tm_scale_bar(position = c("right","top")) +
tm_view()
tm_shape(new_county) +
tm_polygons(
col = "count",
# style = "fixed",
breaks = c(0, 1000, 5000, 10000, 20000, 50000),
palette = "viridis",
border.col = "white",
lwd = 0.3,
title = "Accidents count") +
add_map_decorations()
tm_shape(new_county) +
tm_polygons(
col = "count",
# style = "fixed",
breaks = c(0, 1000, 5000, 10000, 20000, 50000),
palette = "viridis",
# border.col = "white",
lwd = 0.3,
title = "Accidents count") +
add_map_decorations()
tm_shape(new_county) +
tm_polygons(
col = "count",
# style = "fixed",
breaks = c(0, 1000, 5000, 10000, 20000, 50000),
palette = "viridis",
# border.col = "white",
lwd = 0.1,
title = "Accidents count") +
add_map_decorations()
tm_shape(new_county) +
tm_polygons(
col = "count",
# style = "fixed",
breaks = c(0, 1000, 5000, 10000, 20000, 50000),
palette = "viridis",
border.col = "#bac8cc",
lwd = 0.1,
title = "Accidents count") +
add_map_decorations()
accident_count <- tm_shape(new_county) +
tm_polygons(
col = "count",
# style = "fixed",
breaks = c(0, 1000, 5000, 10000, 20000, 50000),
palette = "viridis",
border.col = "#bac8cc",
lwd = 0.1,
title = "Accidents count") +
add_map_decorations()
tmap_save(accident_count, filename = "./Layouts/Accident_count.png", width = 6, height = 10, dpi = 300)
# plot distribution
combined_data%>%
filter(dist_to_nearest_youbike <= threshold) %>%
ggplot(aes(x = dist_to_nearest_youbike)) +
geom_histogram(binwidth = 10) +
# medianline
geom_vline(xintercept = med, color = "blue", linetype = "dashed", size = 1) +
geom_vline(xintercept = mean_dist, color = "red", linetype = "dashed", size = 1) +
annotate("text", x = med, y = Inf, label = paste("Median:", round(med, 2)),
color = "blue", vjust = 1.5, hjust = 1.1, size = 3.5) +
annotate("text", x = mean_dist, y = Inf, label = paste("Median:", round(mean_dist, 2)),
color = "red", vjust = 1.5, hjust = -0.1, size = 3.5) +
labs(title = "Distribution of Distance to Nearest Youbike Station",
x = "Distance to Nearest Youbike Station (meters)",
y = "Frequency") +
theme_minimal()
library(tidyverse)
# plot distribution
combined_data%>%
filter(dist_to_nearest_youbike <= threshold) %>%
ggplot(aes(x = dist_to_nearest_youbike)) +
geom_histogram(binwidth = 10) +
# medianline
geom_vline(xintercept = med, color = "blue", linetype = "dashed", size = 1) +
geom_vline(xintercept = mean_dist, color = "red", linetype = "dashed", size = 1) +
annotate("text", x = med, y = Inf, label = paste("Median:", round(med, 2)),
color = "blue", vjust = 1.5, hjust = 1.1, size = 3.5) +
annotate("text", x = mean_dist, y = Inf, label = paste("Median:", round(mean_dist, 2)),
color = "red", vjust = 1.5, hjust = -0.1, size = 3.5) +
labs(title = "Distribution of Distance to Nearest Youbike Station",
x = "Distance to Nearest Youbike Station (meters)",
y = "Frequency") +
theme_minimal()
# 這個檔案的目的是找出離每個事故最近的youbike設施
youbike <- read_csv('../ST-RTA/ComputedData/Youbike/full_youbike.csv')
combined_data <- read_csv("~/Desktop/ST-RTA/ComputedDataV2/Accident/combined_data_in_taiwan.csv")
library(sf)
youbike_sf <- st_as_sf(youbike, coords = c("PositionLon", "PositionLat"), crs = 4326) %>%
st_transform(3826)
combined_sf <- st_as_sf(combined_data, coords = c("經度", "緯度"), crs = 4326) %>%
st_transform(3826)
nearest_idx <- st_nearest_feature(combined_sf, youbike_sf)
dist_to_youbike <- st_distance(combined_sf, youbike_sf[nearest_idx,], by_element = TRUE)
combined_data$dist_to_nearest_youbike <- as.numeric(dist_to_youbike)
threshold <- quantile(combined_data$dist_to_nearest_youbike, 0.90, na.rm = TRUE)
med <- median(combined_data$dist_to_nearest_youbike, na.rm = TRUE)
mean_dist <- mean(combined_data$dist_to_nearest_youbike, na.rm = TRUE)
# plot distribution
combined_data%>%
filter(dist_to_nearest_youbike <= threshold) %>%
ggplot(aes(x = dist_to_nearest_youbike)) +
geom_histogram(binwidth = 10) +
# medianline
geom_vline(xintercept = med, color = "blue", linetype = "dashed", size = 1) +
geom_vline(xintercept = mean_dist, color = "red", linetype = "dashed", size = 1) +
annotate("text", x = med, y = Inf, label = paste("Median:", round(med, 2)),
color = "blue", vjust = 1.5, hjust = 1.1, size = 3.5) +
annotate("text", x = mean_dist, y = Inf, label = paste("Median:", round(mean_dist, 2)),
color = "red", vjust = 1.5, hjust = -0.1, size = 3.5) +
labs(title = "Distribution of Distance to Nearest Youbike Station",
x = "Distance to Nearest Youbike Station (meters)",
y = "Frequency") +
theme_minimal()
# plot distribution
distance_youbike <- combined_data%>%
filter(dist_to_nearest_youbike <= threshold) %>%
ggplot(aes(x = dist_to_nearest_youbike)) +
geom_histogram(binwidth = 10) +
# medianline
geom_vline(xintercept = med, color = "blue", linetype = "dashed", size = 1) +
geom_vline(xintercept = mean_dist, color = "red", linetype = "dashed", size = 1) +
annotate("text", x = med, y = Inf, label = paste("Median:", round(med, 2)),
color = "blue", vjust = 1.5, hjust = 1.1, size = 3.5) +
annotate("text", x = mean_dist, y = Inf, label = paste("Median:", round(mean_dist, 2)),
color = "red", vjust = 1.5, hjust = -0.1, size = 3.5) +
labs(title = "Distribution of Distance to Nearest Youbike Station",
x = "Distance to Nearest Youbike Station (meters)",
y = "Frequency") +
theme_minimal()
ggsave(distance_youbike, "./Layouts/distance_to_youbike_histogram.png", width = 8, height = 5)
distance_youbike
# plot distribution
distance_youbike <- combined_data%>%
filter(dist_to_nearest_youbike <= threshold) %>%
ggplot(aes(x = dist_to_nearest_youbike)) +
geom_histogram(binwidth = 10) +
# medianline
geom_vline(xintercept = med, color = "blue", linetype = "dashed", size = 1) +
geom_vline(xintercept = mean_dist, color = "red", linetype = "dashed", size = 1) +
annotate("text", x = med, y = Inf, label = paste("Median:", round(med, 2)),
color = "blue", vjust = 1.5, hjust = 1.1, size = 3.5) +
annotate("text", x = mean_dist, y = Inf, label = paste("Median:", round(mean_dist, 2)),
color = "red", vjust = 1.5, hjust = -0.1, size = 3.5) +
labs(title = "Distribution of Distance to Nearest Youbike Station",
x = "Distance to Nearest Youbike Station (meters)",
y = "Frequency") +
theme_minimal()
ggsave(distance_youbike, "./Layouts/distance_to_youbike_histogram.png", width = 8, height = 5)
ggsave("./Layouts/distance_to_youbike_histogram.png", distance_youbike, width = 8, height = 5)
# plot distribution
distance_youbike <- combined_data%>%
# filter(dist_to_nearest_youbike <= threshold) %>%
filter(`道路類別-第1當事者-名稱` == '市區道路') %>%
ggplot(aes(x = dist_to_nearest_youbike)) +
geom_histogram(binwidth = 10) +
# medianline
geom_vline(xintercept = med, color = "blue", linetype = "dashed", size = 1) +
geom_vline(xintercept = mean_dist, color = "red", linetype = "dashed", size = 1) +
annotate("text", x = med, y = Inf, label = paste("Median:", round(med, 2)),
color = "blue", vjust = 1.5, hjust = 1.1, size = 3.5) +
annotate("text", x = mean_dist, y = Inf, label = paste("Median:", round(mean_dist, 2)),
color = "red", vjust = 1.5, hjust = -0.1, size = 3.5) +
labs(title = "Distribution of Distance to Nearest Youbike Station",
x = "Distance to Nearest Youbike Station (meters)",
y = "Frequency") +
theme_minimal()
distance_youbike
urban_accidents <- combined_data%>%filter(`道路類別-第1當事者-名稱` == '市區道路')
urban_accidents$dist_to_nearest_youbike <- as.numeric(dist_to_youbike)
urban_accidents <- combined_data%>%filter(`道路類別-第1當事者-名稱` == '市區道路')
urban_accidents$dist_to_nearest_youbike <- as.numeric(dist_to_youbike)
combined_data <- read_csv("~/Desktop/ST-RTA/ComputedDataV2/Accident/combined_data_in_taiwan.csv")%>%
filter(`道路類別-第1當事者-名稱` == '市區道路')
youbike_sf <- st_as_sf(youbike, coords = c("PositionLon", "PositionLat"), crs = 4326) %>%
st_transform(3826)
combined_sf <- st_as_sf(combined_data, coords = c("經度", "緯度"), crs = 4326) %>%
st_transform(3826)
nearest_idx <- st_nearest_feature(combined_sf, youbike_sf)
dist_to_youbike <- st_distance(combined_sf, youbike_sf[nearest_idx,], by_element = TRUE)
urban_accidents$dist_to_nearest_youbike <- as.numeric(dist_to_youbike)
threshold <- quantile(combined_data$dist_to_nearest_youbike, 0.90, na.rm = TRUE)
med <- median(combined_data$dist_to_nearest_youbike, na.rm = TRUE)
mean_dist <- mean(combined_data$dist_to_nearest_youbike, na.rm = TRUE)
med <- median(combined_data$dist_to_nearest_youbike, na.rm = TRUE)
urban_accidents$dist_to_nearest_youbike <- as.numeric(dist_to_youbike)
threshold <- quantile(combined_data$dist_to_nearest_youbike, 0.90, na.rm = TRUE)
med <- median(combined_data$dist_to_nearest_youbike, na.rm = TRUE)
mean_dist <- mean(combined_data$dist_to_nearest_youbike, na.rm = TRUE)
med
combined_data
combined_data$dist_to_nearest_youbike
combined_data$dist_to_nearest_youbike <- as.numeric(dist_to_youbike)
threshold <- quantile(combined_data$dist_to_nearest_youbike, 0.90, na.rm = TRUE)
med <- median(combined_data$dist_to_nearest_youbike, na.rm = TRUE)
mean_dist <- mean(combined_data$dist_to_nearest_youbike, na.rm = TRUE)
# plot distribution
distance_youbike <- combined_data%>%
# filter(dist_to_nearest_youbike <= threshold) %>%
ggplot(aes(x = dist_to_nearest_youbike)) +
geom_histogram(binwidth = 10) +
# medianline
geom_vline(xintercept = med, color = "blue", linetype = "dashed", size = 1) +
geom_vline(xintercept = mean_dist, color = "red", linetype = "dashed", size = 1) +
annotate("text", x = med, y = Inf, label = paste("Median:", round(med, 2)),
color = "blue", vjust = 1.5, hjust = 1.1, size = 3.5) +
annotate("text", x = mean_dist, y = Inf, label = paste("Median:", round(mean_dist, 2)),
color = "red", vjust = 1.5, hjust = -0.1, size = 3.5) +
labs(title = "Distribution of Distance to Nearest Youbike Station",
x = "Distance to Nearest Youbike Station (meters)",
y = "Frequency") +
theme_minimal()
distance_youbike
# plot distribution
distance_youbike <- combined_data%>%
filter(dist_to_nearest_youbike <= threshold) %>%
ggplot(aes(x = dist_to_nearest_youbike)) +
geom_histogram(binwidth = 10) +
# medianline
geom_vline(xintercept = med, color = "blue", linetype = "dashed", size = 1) +
geom_vline(xintercept = mean_dist, color = "red", linetype = "dashed", size = 1) +
annotate("text", x = med, y = Inf, label = paste("Median:", round(med, 2)),
color = "blue", vjust = 1.5, hjust = 1.1, size = 3.5) +
annotate("text", x = mean_dist, y = Inf, label = paste("Median:", round(mean_dist, 2)),
color = "red", vjust = 1.5, hjust = -0.1, size = 3.5) +
labs(title = "Distribution of Distance to Nearest Youbike Station",
x = "Distance to Nearest Youbike Station (meters)",
y = "Frequency") +
theme_minimal()
distance_youbike
# plot distribution
distance_youbike <- combined_data%>%
filter(dist_to_nearest_youbike <= threshold) %>%
ggplot(aes(x = dist_to_nearest_youbike)) +
geom_histogram(binwidth = 10) +
# medianline
geom_vline(xintercept = med, color = "blue", linetype = "dashed", size = 1) +
geom_vline(xintercept = mean_dist, color = "red", linetype = "dashed", size = 1) +
annotate("text", x = med, y = Inf, label = paste("Median:", round(med, 2)),
color = "blue", vjust = 1.5, hjust = 1.1, size = 3.5) +
annotate("text", x = mean_dist, y = Inf, label = paste("Median:", round(mean_dist, 2)),
color = "red", vjust = 1.5, hjust = 1.1, size = 3.5) +
labs(title = "Distribution of Distance to Nearest Youbike Station",
x = "Distance to Nearest Youbike Station (meters)",
y = "Frequency") +
theme_minimal()
distance_youbike
ggsave("./Layouts/distance_to_youbike_histogram.png", distance_youbike, width = 8, height = 5)
