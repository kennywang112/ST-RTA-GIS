}
for (i in adj_list) {
tempt <- c()
for (j in i) {
tempt <- c(tempt, j)
}
print(tempt)
# adj_var <- c(adj_var, list(i))
}
adj_var <- c()
for (i in adj_list) {
tempt <- c()
for (j in i) {
tempt <- c(tempt, j)
}
print(tempt)
adj_var <- c(adj_var, tempt)
}
adj_var <- c()
for (i in adj_list) {
tempt <- c()
for (j in i) {
tempt <- c(tempt, j)
}
print(tempt)
adj_var <- c(adj_var, tempt)
}
adj_var <- c()
for (i in adj_list) {
tempt <- c()
for (j in i) {
tempt <- c(tempt, j)
}
print(tempt)
# adj_var <- c(adj_var, tempt)
}
adj_var <- c()
for (i in adj_list) {
tempt <- c()
for (j in i) {
tempt <- c(tempt, j)
}
print(list(tempt))
# adj_var <- c(adj_var, tempt)
}
adj_var <- c()
for (i in adj_list) {
tempt <- c()
for (j in i) {
tempt <- c(tempt, j)
}
print(list(tempt))
adj_var <- c(adj_var, list(tempt))
}
View(adj_var)
adj_list
data.frame('eigen_centrality' = e_scores, 'betweenness' = b_scores)
features <- data.frame('eigen_centrality' = e_scores, 'betweenness' = b_scores)
View(features)
correlation
length(g)
length(e_scores)
features
adj_matrix
features[0,1]
features[1,1]
features[1,2]
features[1,3]
for(i in adj_list) {
print(i)
}
seq(1, 9, by = 2)
length(adj_list)
for(i in 1:length(adj_list)) {
print(i)
}
for(i in 1:length(adj_list)) {
print(adj_list[i])
}
print(j)
for(i in 1:length(adj_list)) {
for (j in i) {
print(j)
}
}
print(i)
for(i in 1:length(adj_list)) {
print(i)
}
for(i in 1:length(adj_list)) {
print(adj_list[i])
}
for(i in 1:length(adj_list)) {
features[i,3] <- adj_list[i]
}
for(i in 1:length(adj_list)) {
print(i)
features[i, 3] <- adj_list[i]
}
features[1, 3]
features[1, 3] <-  adj_list[1]
features[1, 3] <-  adj_list[1]
adj_list[1]
length(adj_list[1])
adj_list[1] == 0
adj_list[1] == integer(0)
adj_list[2] == integer(0)
adj_list[5] == integer(0)
adj_list[1]
adj_list[2]
adj_list[3]
adj_list[10]
adj_list[13] == integer(0)
adj_list[13]
adj_list[13] length(adj_list)
View(adj_list)
adj_list[14] length(adj_list)
adj_list[14]
length(adj_list[14])
adj_list[14] > 0
adj_list[13] > 0
(adj_list[13] > 0) || (length(adj_list[13]) > 1)
length(adj_list[13]) > 1
adj_list[13]
length(adj_list[13]) > 1
length(adj_list[13])
length(adj_list[13])
adj_list[13] > 0
adj_list[13]
adj_list[[13]] > 0
adj_list[[10]]
adj_list[[13]][1]
for(i in 1:length(adj_list)) {
print(adj_list[[i]])
# if length()
# features[i, 3] <- adj_list[i]
}
adj_list[[10]]
adj_list[[1]] == 0
adj_list[[9]] == 0
adj_list[[9]]
adj_list[[7]]
adj_list[[7]] == 0
adj_list[[7]] == TRUE
adj_list[[7]] == FALSE
adj_list[[7]]
View(adj_list)
value(adj_list[[7]])
adj_list[[7]]
adj_list
adj_list[[13]]
adj_list
adj_list[[7]]
features[1, 3] <- adj_list[1]
adj_list[1]
features
adj_list[1]
features[1, 3] <- adj_list[1]
features[1, 3]
features[1, 3] <- 1
features[1, 3] <- adj_list[1]
features[1, 3]
features
View(adj_list)
Mapper$num_vertices
adj_matrix
adj_matrix[1,]
adj_list
################# SNA ###################
adj_matrix <- Mapper$adjacency
adj_list <- lapply(1:Mapper$num_vertices, function(i) {
neighbors <- which(adj_matrix[i, ] > 0)
print(neighbors)
return(neighbors[neighbors != i]) # 移除自己
})
features
if (adj_list[0]) {
print('hi')
}
adj_list[0]
adj_list <- lapply(1:Mapper$num_vertices, function(i) {
neighbors <- which(adj_matrix[i, ] > 0)
return(neighbors[neighbors != i]) # 移除自己
})
if (adj_list[0]) {
print('hi')
}
adj_list
adj_list[0]
if (adj_list[[1]]) {
print('hi')
}
adj_list[[1]]
if (adj_list[0]) {
print('hi')
}
adj_list[0]
length(adj_list[0])
for( i in adj_list) {
if (length(i[0]) > 0) {
print(paste('hi in ', i))
}
}
for( i in adj_list) {
print(i)
if (length(i[0]) > 0) {
print(paste('hi in ', i))
}
}
for( i in adj_list) {
)
length(i[0]
length(i[0]
adj_list
for( i in adj_list) {
for( i in adj_list) {
print(length(i[0]))
if (length(i[0]) > 0) {
print(paste('hi in ', i))
}
}
)
for( i in adj_list) {
print(length(i[0]))
# if (length(i[0]) > 0) {
#   print(paste('hi in ', i))
# }
}
for(i in 1:length(adj_list)) {
print(length(adj_list[0]))
# if (length(i[0]) > 0) {
#   print(paste('hi in ', i))
# }
}
for(i in 1:length(adj_list)) {
print(length(adj_list[i]))
# if (length(i[0]) > 0) {
#   print(paste('hi in ', i))
# }
}
for(i in 1:length(adj_list)) {
print(i)
# print(length(adj_list[i]))
# if (length(i[0]) > 0) {
#   print(paste('hi in ', i))
# }
}
for(i in 1:length(adj_list)) {
print(adj_list[i])
# print(length(adj_list[i]))
# if (length(i[0]) > 0) {
#   print(paste('hi in ', i))
# }
}
length(adj_list[1])
length(adj_list[1])
adj_list[1]
adj_list[[1]]
length(adj_list[[1]])
length(adj_list[[2]])
length(adj_list[[300]])
adj_list
length(adj_list[[425]])
for(i in 1:length(adj_list)) {
for(i in 1:length(adj_list)) {
print(adj_list[[i]])
# print(length(adj_list[i]))
# if (length(i[0]) > 0) {
#   print(paste('hi in ', i))
# }
}
)
for(i in 1:length(adj_list)) {
print(adj_list[[i]])
# print(length(adj_list[i]))
# if (length(i[0]) > 0) {
#   print(paste('hi in ', i))
# }
}
for(i in 1:length(adj_list)) {
print(length(adj_list[[i]]))
# print(length(adj_list[i]))
# if (length(i[0]) > 0) {
#   print(paste('hi in ', i))
# }
}
for(i in 1:length(adj_list)) {
if (length(adj_list[[i]]) > 0) {
print(paste('hi in ', i))
}
}
for(i in 1:length(adj_list)) {
if (length(adj_list[[i]]) > 0) {
features[i, 3] <- adj_list[[i]]
}
}
for(i in 1:length(adj_list)) {
if (length(adj_list[[i]]) > 0) {
features[i, 3] <- list(adj_list[[i]])
}
}
features
View(features)
adj_list
adj_list[[418]]
list(adj_list[[418]])
features[418, 3] <- list(adj_list[[418]])
features[418, 3]
adj_list
for(i in 1:length(adj_list)) {
features$neighbors[[i]] <- adj_list[[i]]
}
features
features <- data.frame('eigen_centrality' = e_scores, 'betweenness' = b_scores)
for(i in 1:length(adj_list)) {
features$neighbors[[i]] <- adj_list[[i]]
}
features <- tibble(
eigen_centrality = e_scores,
betweenness = b_scores,
neighbors = adj_list
)
features
source("~/Desktop/ST-RTA-GIS/Analyze/SNA.R")
adj_matrix <- Mapper$adjacency
adj_list <- lapply(1:Mapper$num_vertices, function(i) {
neighbors <- which(adj_matrix[i, ] > 0)
return(neighbors[neighbors != i]) # 移除自己
})
# find total unique indices
uniq_idx <- sort(unique(unlist(Mapper$points_in_vertex, use.names = FALSE)))
length(uniq_idx) == dim(all_features)[1]
## Betweenness and Eigenvector Centrality
g <- graph_from_adjacency_matrix(Mapper$adjacency, mode = "undirected")
e_result <- eigen_centrality(g)
source('./utils/model.R')
b_labels <- rep(0, length(b_scores))
top_10_indices <- head(order(b_scores, decreasing = TRUE), 10)
b_labels[top_10_indices] <- 1
e_labels <- rep(0, length(e_scores))
top_10_eigen_indices <- head(order(e_scores, decreasing = TRUE), 10)
e_labels[top_10_eigen_indices] <- 1
source('./Analyze/SNAplot.R')
source('../TDA-R/MapperAlgo/R/MapperCorrelation.R')
MapperCorrelation(Mapper, original_data = filter_data, labels = list(all_features$bn_feature, all_features$hotspot), use_embedding = list(FALSE, FALSE))
source('../TDA-R/MapperAlgo/R/MapperCorrelation.R')
MapperCorrelation(Mapper, original_data = filter_data, labels = list(all_features$bn_feature, all_features$hotspot), use_embedding = list(FALSE, FALSE))
library(tidyverse)
library(igraph)
library(networkD3)
library(ggraph)
library(tidygraph)
library(parallel)
library(doParallel)
source('../TDA-R/MapperAlgo/R/EdgeVertices.R')
source('../TDA-R/MapperAlgo/R/ConvertLevelsets.R')
source('../TDA-R/MapperAlgo/R/Cover.R')
source('../TDA-R/MapperAlgo/R/Cluster.R')
source('../TDA-R/MapperAlgo/R/SimplicialComplex.R')
source('../TDA-R/MapperAlgo/R/MapperAlgo.R')
source('../TDA-R/MapperAlgo/R/Plotter.R')
filter_data <- read_csv("../ST-RTA/ComputedDataV4/ForModel/filtered_dataV1.csv")
filter_data%>%summary()
# all_features <- read_csv("../ST-RTA/ComputedDataV4/ForModel/all_features_gdf.csv")
all_features <- read_csv("../ST-RTA/ComputedDataV4/ForModel/all_features.csv")
all_features$hotspot <- case_when(
all_features$hotspot == 'Not Significant' ~ 0,
TRUE ~ 1
)
all_features <- all_features%>%
mutate(
bn_feature = ifelse(
(
(
(`車道劃分設施-分道設施-路面邊線名稱_無` > 0)
) &
(
(`當事者區分-類別-大類別名稱-車種_小客車(含客、貨兩用)` > 0)
) &
(
(`cause-group_Decision` > 0)
)
),
1,
0
)
)
all_features$bn_feature%>%table()
# normalize
n_data <- as.data.frame(scale(filter_data))
n_data%>%summary()
plot_data <- n_data %>%
mutate(is_hotspot = factor(all_features$hotspot)) %>%
pivot_longer(cols = -is_hotspot, names_to = "variable", values_to = "value")
plot_data %>%
ggplot(aes(x = value, fill = is_hotspot)) +
geom_histogram(bins = 50, color = "white", alpha = 0.8, position = "stack") +
facet_wrap(~variable, scales = "free") +
# Manual color scale with English labels
scale_fill_manual(values = c("0" = "#999999", "1" = "#E63946"),
name = "Hotspot Status",  labels = c("No", "Yes")) +
theme_minimal() +
labs(title = "Distribution of Variables by Hotspot Status",
subtitle = "Red indicates hotspot occurrences within the value range",
x = "Normalized Value",
y = "Frequency") +
theme(legend.position = "top")
data <- all_features%>%select(-hotspot)
MapperCorrelation(Mapper, original_data = filter_data, labels = list(all_features$bn_feature, all_features$hotspot), use_embedding = list(FALSE, FALSE))
length(g)
length(e_scores)
features <- tibble(
eigen_centrality = e_scores,
betweenness = b_scores,
neighbors = adj_list,
points_in_vertex = Mapper$points_in_vertex
)
time_taken <- system.time({
Mapper <- MapperAlgo(
original_data = data,
filter_values = n_data[,1:3],
percent_overlap = 0.5,
# methods = "dbscan",
# method_params = list(eps = 0.3, minPts = 3),
# methods = "hierarchical",
# method_params = list(num_bins_when_clustering = 5, method = 'ward.D2'),
methods = "kmeans",
method_params = list(max_kmeans_clusters = 3),
# methods = "pam",
# method_params = list(num_clusters = 2),
cover_type = 'stride',
# intervals = 4,
interval_width = 0.7,
num_cores = 12
)
})
features <- tibble(
eigen_centrality = e_scores,
betweenness = b_scores,
neighbors = adj_list,
points_in_vertex = Mapper$points_in_vertex
)
adj_matrix <- Mapper$adjacency
adj_list <- lapply(1:Mapper$num_vertices, function(i) {
neighbors <- which(adj_matrix[i, ] > 0)
return(neighbors[neighbors != i]) # 移除自己
})
# find total unique indices
uniq_idx <- sort(unique(unlist(Mapper$points_in_vertex, use.names = FALSE)))
length(uniq_idx) == dim(all_features)[1]
## Betweenness and Eigenvector Centrality
g <- graph_from_adjacency_matrix(Mapper$adjacency, mode = "undirected")
e_result <- eigen_centrality(g)
e_scores <- e_result$vector
b_scores <- betweenness(g, normalized = TRUE)
# 找橋樑
top_nodes <- sort(b_scores, decreasing = TRUE)
print(head(top_nodes, 10))
b_labels <- rep(0, length(b_scores))
top_10_indices <- head(order(b_scores, decreasing = TRUE), 10)
b_labels[top_10_indices] <- 1
e_labels <- rep(0, length(e_scores))
top_10_eigen_indices <- head(order(e_scores, decreasing = TRUE), 10)
e_labels[top_10_eigen_indices] <- 1
source('./Analyze/SNAplot.R')
MapperPlotterV2(
Mapper,
# label = e_scores,
label = e_labels,
data = filter_data,
is_node_attribute = TRUE
)
features <- tibble(
eigen_centrality = e_scores,
betweenness = b_scores,
neighbors = adj_list,
points_in_vertex = Mapper$points_in_vertex
)
# all_features <- read_csv("../ST-RTA/ComputedDataV4/ForModel/all_features.csv")
grid_filter <- read_csv("../ST-RTA/ComputedDataV2/Grid/grid_filter.csv")$accident_indices
combined_data <- read_csv("../ST-RTA/ComputedDataV2/Grid/combined_data.csv")
all_features_grid <- cbind(all_features, grid_filter)
filter_features <- features%>%
mutate(
neighbor_points = map(neighbors, function(nbr_ids) {
# get all points in neighbor vertices
points_list <- points_in_vertex[nbr_ids]
all_nbr_points <- unlist(points_list)
unique(all_nbr_points)
})
)%>%
filter(!map_lgl(neighbor_points, is.null))
cols <- c(
'車道劃分設施-分道設施-快車道或一般車道間名稱',
'車道劃分設施-分道設施-快慢車道間名稱',
'車道劃分設施-分道設施-路面邊線名稱',
'車道劃分設施-分向設施大類別名稱',
'事故類型及型態大類別名稱',
'道路型態大類別名稱',
'號誌-號誌種類名稱',
'速限-第1當事者',
'youbike_100m_count',
'mrt_100m_count',
'parkinglot_100m_count',
'當事者區分-類別-大類別名稱-車種',
'cause_group',
'type'
)
source('./utils/model.R')
# Analyze betweenness top 10 nodes
bdt <- get_model_data(filter_features, betweenness, top_k = 10)
betweenness_info <- model_from_node(bdt[[1]], bdt[[2]])
