################# SNA ###################
adj_matrix <- res$adjacency
################# SNA ###################
adj_matrix <- Mapper$adjacency
adj_matrix
neighbor_indices <- which(adj_matrix[5, ] > 0)
neighbor_indices <- which(adj_matrix[5, ] > 0)
neighbor_indices <- neighbor_indices[neighbor_indices != 5]
neighbor_indices
neighbor_indices <- which(adj_matrix[1, ] > 0)
neighbor_indices <- neighbor_indices[neighbor_indices != 5]
neighbor_indices
neighbor_indices <- which(adj_matrix[10, ] > 0)
neighbor_indices <- neighbor_indices[neighbor_indices != 5]
neighbor_indices
adj_list <- lapply(1:res$num_vertices, function(i) {
neighbors <- which(adj_matrix[i, ] > 0)
return(neighbors[neighbors != i]) # 移除自身
})
adj_list <- lapply(1:Mappe$num_vertices, function(i) {
neighbors <- which(adj_matrix[i, ] > 0)
return(neighbors[neighbors != i]) # 移除自身
})
adj_list <- lapply(1:Mapper$num_vertices, function(i) {
neighbors <- which(adj_matrix[i, ] > 0)
return(neighbors[neighbors != i]) # 移除自身
})
adj_list
Mapper$adjacency
adj_matrix
adj_list
all_features
# find total unique indices
uniq_idx <- sort(unique(unlist(Mapper$points_in_vertex, use.names = FALSE)))
uniq_idx ==
dim(all_features)
dim(all_features)
uniq_idx ==
dim(all_features)[0]
dim(all_features)[1]
uniq_idx == dim(all_features)[1]
uniq_idx
length(uniq_idx) == dim(all_features)[1]
length(uniq_idx) == dim(all_features)[1]
uniq_idx
adj_list
g <- graph_from_adjacency_matrix(mapper_result$adjacency, mode = "undirected")
g <- graph_from_adjacency_matrix(Mapper$adjacency, mode = "undirected")
b_scores <- betweenness(g, normalized = TRUE)
# 找橋樑
top_nodes <- sort(b_scores, decreasing = TRUE)
print(head(top_nodes, 10))
top_nodes
MapperPlotter(Mapper,
label=b_scores,
data=filter_data,
type="forceNetwork",
avg=TRUE,
use_embedding=FALSE)
adj_indices <- which(Mapper$adjacency == 1, arr.ind = TRUE)
adj_indices <- which(Mapper$adjacency == 1, arr.ind = TRUE)
Links <- data.frame(source = adj_indices[,1]-1, target = adj_indices[,2]-1)
Nodes <- data.frame(name = 1:Mapper$num_vertices,
group = as.numeric(cut(b_scores, breaks = 10)),
size = sapply(Mapper$points_in_vertex, length))
forceNetwork(Links = Links, Nodes = Nodes,
Source = "source", Target = "target",
Value = 1, NodeID = "name",
Group = "group", opacity = 0.8,
zoom = TRUE, bounded = TRUE,
legend = TRUE)
source('./SNAplot.R')
source('/SNAplot.R')
source('../Analysis/SNAplot.R')
source('./Analyze/SNAplot.R')
MapperPlotter(
Mapper,
label = b_scores,       # 傳入算好的分數
data = filter_data,     # 為了拿資料長度(雖然這模式下沒用到，但填著無妨)
is_node_attribute = TRUE # 告訴函數：這已經是節點分數了！
)
source('./Analyze/SNAplot.R')
MapperPlotter(
Mapper,
label = b_scores,
data = filter_data,
is_node_attribute = TRUE
)
MapperPlotteV2r(
Mapper,
label = b_scores,
data = filter_data,
is_node_attribute = TRUE
)
MapperPlotterV2(
Mapper,
label = b_scores,
data = filter_data,
is_node_attribute = TRUE
)
g <- eigen_centrality(Mapper$adjacency)
b_scores <- eigen_centrality(g)
adj_indices <- which(Mapper$adjacency == 1, arr.ind = TRUE)
Links <- data.frame(source = adj_indices[,1]-1, target = adj_indices[,2]-1)
Nodes <- data.frame(name = 1:Mapper$num_vertices,
group = as.numeric(cut(b_scores, breaks = 10)),
size = sapply(Mapper$points_in_vertex, length))
source('./Analyze/SNAplot.R')
MapperPlotterV2(
Mapper,
label = b_scores,
data = filter_data,
is_node_attribute = TRUE
)
b_scores
b_scores <- eigen_centrality(g)
## Betweenness
g <- graph_from_adjacency_matrix(Mapper$adjacency, mode = "undirected")
b_scores <- eigen_centrality(g)
MapperPlotterV2(
Mapper,
label = b_scores,
data = filter_data,
is_node_attribute = TRUE
)
b_scores <- betweenness(g, normalized = TRUE)
MapperPlotterV2(
Mapper,
label = b_scores,
data = filter_data,
is_node_attribute = TRUE
)
## Betweenness
g <- graph_from_adjacency_matrix(Mapper$adjacency, mode = "undirected")
e_scores <- eigen_centrality(g)
e_scores <- e_result$vector
b_scores <- betweenness(g, normalized = TRUE)
## Betweenness
g <- graph_from_adjacency_matrix(Mapper$adjacency, mode = "undirected")
e_result <- eigen_centrality(g)
e_scores <- e_result$vector
b_scores <- betweenness(g, normalized = TRUE)
# 找橋樑
top_nodes <- sort(b_scores, decreasing = TRUE)
MapperPlotterV2(
Mapper,
label = e_scores,
data = filter_data,
is_node_attribute = TRUE
)
graph_from_adjacency_matrix(Mapper$adjacency, mode = "undirected")
MapperPlotterV2(
Mapper,
label = e_scores,
data = filter_data,
is_node_attribute = TRUE
)
MapperPlotterV2(
Mapper,
label = b_scores,
data = filter_data,
is_node_attribute = TRUE
)
MapperPlotterV2(
Mapper,
label = b_scores,
data = filter_data,
is_node_attribute = TRUE
)
MapperPlotterV2(
Mapper,
label = e_scores,
data = filter_data,
is_node_attribute = TRUE
)
MapperPlotterV2(
Mapper,
label = all_features$hotspot,
data = filter_data,
is_node_attribute = FALSE
)
MapperPlotterV2(
Mapper,
label = all_features$hotspot,
data = filter_data,
avg=TRUE,
is_node_attribute = FALSE
)
MapperPlotterV2(
Mapper,
label = e_scores,
data = filter_data,
is_node_attribute = TRUE
)
library(tidyverse)
library(igraph)
library(networkD3)
library(ggraph)
library(tidygraph)
library(MapperAlgo)
library(parallel)
library(doParallel)
filter_data <- read_csv("../ST-RTA/ComputedDataV4/ForModel/filtered_dataV1.csv")
filter_data%>%summary()
# all_features <- read_csv("../ST-RTA/ComputedDataV4/ForModel/all_features_gdf.csv")
all_features <- read_csv("../ST-RTA/ComputedDataV4/ForModel/all_features.csv")
all_features$hotspot <- case_when(
all_features$hotspot == 'Not Significant' ~ 0,
TRUE ~ 1
)
all_features <- all_features%>%
mutate(
bn_feature = ifelse(
(
(
(`車道劃分設施-分道設施-路面邊線名稱_無` > 0)
) &
(
(`當事者區分-類別-大類別名稱-車種_小客車(含客、貨兩用)` > 0)
) &
(
(`cause-group_Decision` > 0)
)
),
1,
0
)
)
all_features$bn_feature%>%table()
all_features$`車道劃分設施-分道設施-路面邊線名稱_無 x 當事者區分-類別-大類別名稱-車種_小客車(含客、貨兩用) x cause-group_Decision`
all_features$`車道劃分設施-分道設施-路面邊線名稱_無 x 當事者區分-類別-大類別名稱-車種_小客車(含客、貨兩用) x cause-group_Decision`
# normalize
n_data <- as.data.frame(scale(filter_data))
n_data%>%summary()
n_data%>%ggplot()+geom_bar(aes(x=n_data[,1]), bins=100)
n_data%>%ggplot()+geom_bar(aes(x=n_data[,1]))
n_data%>%ggplot()+geom_col(aes(x=1:nrow(n_data), y=n_data[,1]), stat='identity')
# 將寬資料轉成長資料，方便一次畫出所有變數
n_data %>%
pivot_longer(cols = everything(), names_to = "variable", values_to = "value") %>%
ggplot(aes(x = value)) +
# bins 可以調整長條的細緻度
geom_histogram(bins = 50, fill = "#69b3a2", color = "white", alpha = 0.8) +
facet_wrap(~variable, scales = "free") + # 分面顯示
theme_minimal() +
labs(title = "各變數分佈直方圖", subtitle = "檢視是否為鐘形分佈", x = "標準化數值", y = "頻率")
n_data %>%
pivot_longer(cols = everything(), names_to = "variable", values_to = "value") %>%
ggplot(aes(x = value)) +
geom_histogram(bins = 50, fill = "#69b3a2", color = "white", alpha = 0.8) +
facet_wrap(~variable, scales = "free") +
theme_minimal() +
labs(title = "各變數分佈直方圖", subtitle = "檢視是否為鐘形分佈", x = "標準化數值", y = "頻率")
n_data
n_data %>%
pivot_longer(cols = everything(), names_to = "variable", values_to = "value") %>%
ggplot(aes(sample = value)) +
stat_qq(alpha = 0.1) + # alpha 設低一點因為你有10萬筆資料，避免重疊太嚴重
stat_qq_line(color = "red") +
facet_wrap(~variable, scales = "free") +
theme_light() +
labs(title = "Normal Q-Q Plots", subtitle = "點若落在紅線上代表符合常態分佈")
n_data %>%
pivot_longer(cols = everything(), names_to = "variable", values_to = "value") %>%
ggplot(aes(x = value)) +
geom_histogram(bins = 50, fill = "#69b3a2", color = "white", alpha = 0.8) +
facet_wrap(~variable, scales = "free") +
theme_minimal() +
labs(title = "各變數分佈直方圖", subtitle = "檢視是否為鐘形分佈", x = "標準化數值", y = "頻率")
n_data %>%
pivot_longer(cols = everything(), names_to = "variable", values_to = "value")
all_features$hotspot
n_data %>% cbind(all_features$hotspot)
n_data%>%
cbind(all_features$hotspot)%>%
pivot_longer(cols = everything(), names_to = "variable", values_to = "value") %>%
ggplot(aes(x = value)) +
geom_histogram(bins = 50, fill = "#69b3a2", color = "white", alpha = 0.8) +
facet_wrap(~variable, scales = "free") +
theme_minimal() +
labs(title = "各變數分佈直方圖", subtitle = "檢視是否為鐘形分佈", x = "標準化數值", y = "頻率")
# 2. 繪圖
plot_data %>%
ggplot(aes(x = value, fill = is_hotspot)) + # 設定 fill 為熱點欄位
geom_histogram(bins = 50, color = "white", alpha = 0.8, position = "stack") +
facet_wrap(~variable, scales = "free") +
# 自定義顏色：0(非熱點)用灰色，1(熱點)用紅色，這樣對比最強烈
scale_fill_manual(values = c("0" = "#999999", "1" = "#E63946"),
name = "是否為熱點",
labels = c("否", "是")) +
theme_minimal() +
labs(title = "各變數分佈與熱點組成",
subtitle = "紅色佔比越高，代表該數值區間越容易形成熱點",
x = "標準化數值",
y = "頻率") +
theme(legend.position = "top")
plot_data <- n_data %>%
# 將 hotspot 加入成為一個欄位，而不是透過 cbind 硬接
mutate(is_hotspot = factor(all_features$hotspot)) %>%
# 重要：pivot_longer 時要排除 is_hotspot，保留它用來上色
pivot_longer(cols = -is_hotspot, names_to = "variable", values_to = "value")
# 2. 繪圖
plot_data %>%
ggplot(aes(x = value, fill = is_hotspot)) + # 設定 fill 為熱點欄位
geom_histogram(bins = 50, color = "white", alpha = 0.8, position = "stack") +
facet_wrap(~variable, scales = "free") +
# 自定義顏色：0(非熱點)用灰色，1(熱點)用紅色，這樣對比最強烈
scale_fill_manual(values = c("0" = "#999999", "1" = "#E63946"),
name = "是否為熱點",
labels = c("否", "是")) +
theme_minimal() +
labs(title = "各變數分佈與熱點組成",
subtitle = "紅色佔比越高，代表該數值區間越容易形成熱點",
x = "標準化數值",
y = "頻率") +
theme(legend.position = "top")
# 1. Prepare data
plot_data <- n_data %>%
# Convert hotspot to factor for coloring
mutate(is_hotspot = factor(all_features$hotspot)) %>%
# pivot_longer, excluding the hotspot column
pivot_longer(cols = -is_hotspot, names_to = "variable", values_to = "value")
# 2. Plot with English labels
plot_data %>%
ggplot(aes(x = value, fill = is_hotspot)) +
geom_histogram(bins = 50, color = "white", alpha = 0.8, position = "stack") +
facet_wrap(~variable, scales = "free") +
# Manual color scale with English labels
scale_fill_manual(values = c("0" = "#999999", "1" = "#E63946"),
name = "Hotspot Status",      # Legend title
labels = c("No", "Yes")) +    # Legend labels
theme_minimal() +
labs(title = "Distribution of Variables by Hotspot Status",
subtitle = "Red indicates hotspot occurrences within the value range",
x = "Normalized Value",
y = "Frequency") +
theme(legend.position = "top")
plot_data <- n_data %>%
mutate(is_hotspot = factor(all_features$hotspot)) %>%
pivot_longer(cols = -is_hotspot, names_to = "variable", values_to = "value")
plot_data %>%
ggplot(aes(x = value, fill = is_hotspot)) +
geom_histogram(bins = 50, color = "white", alpha = 0.8, position = "stack") +
facet_wrap(~variable, scales = "free") +
# Manual color scale with English labels
scale_fill_manual(values = c("0" = "#999999", "1" = "#E63946"),
name = "Hotspot Status",  labels = c("No", "Yes")) +
theme_minimal() +
labs(title = "Distribution of Variables by Hotspot Status",
subtitle = "Red indicates hotspot occurrences within the value range",
x = "Normalized Value",
y = "Frequency") +
theme(legend.position = "top")
time_taken <- system.time({
Mapper <- MapperAlgo(
filter_values = n_data[,1:3],
percent_overlap = 0.5,
# methods = "dbscan",
# method_params = list(eps = 0.3, minPts = 3),
# methods = "hierarchical",
# method_params = list(num_bins_when_clustering = 10, method = 'ward.D2'),
methods = "kmeans",
method_params = list(max_kmeans_clusters = 4),
# methods = "pam",
# method_params = list(num_clusters = 2),
cover_type = 'stride',
# intervals = 4,
interval_width = 1.6,
num_cores = 12
)
})
time_taken <- system.time({
Mapper <- MapperAlgo(
filter_values = n_data[,1:3],
percent_overlap = 0.5,
# methods = "dbscan",
# method_params = list(eps = 0.3, minPts = 3),
# methods = "hierarchical",
# method_params = list(num_bins_when_clustering = 10, method = 'ward.D2'),
methods = "kmeans",
method_params = list(max_kmeans_clusters = 4),
# methods = "pam",
# method_params = list(num_clusters = 2),
cover_type = 'stride',
# intervals = 4,
interval_width = 1,
num_cores = 12
)
})
source('../TDA-R/MapperAlgo/R/Plotter.R')
# `車道劃分設施-分道設施-路面邊線名稱_無 x 當事者區分-類別-大類別名稱-車種_小客車(含客、貨兩用) x cause-group_Decision`
MapperPlotter(Mapper,
label=all_features$hotspot,
data=filter_data,
type="forceNetwork",
avg=TRUE,
use_embedding=FALSE)
Mapper <- MapperAlgo(
filter_values = n_data[,1:3],
percent_overlap = 0.4,
# methods = "dbscan",
# method_params = list(eps = 0.3, minPts = 3),
# methods = "hierarchical",
# method_params = list(num_bins_when_clustering = 10, method = 'ward.D2'),
methods = "kmeans",
method_params = list(max_kmeans_clusters = 5),
# methods = "pam",
# method_params = list(num_clusters = 2),
cover_type = 'stride',
# intervals = 4,
interval_width = 1,
num_cores = 12
)
# `車道劃分設施-分道設施-路面邊線名稱_無 x 當事者區分-類別-大類別名稱-車種_小客車(含客、貨兩用) x cause-group_Decision`
MapperPlotter(Mapper,
label=all_features$hotspot,
data=filter_data,
type="forceNetwork",
avg=TRUE,
use_embedding=FALSE)
Mapper <- MapperAlgo(
filter_values = n_data[,1:3],
percent_overlap = 0.3,
# methods = "dbscan",
# method_params = list(eps = 0.3, minPts = 3),
# methods = "hierarchical",
# method_params = list(num_bins_when_clustering = 10, method = 'ward.D2'),
methods = "kmeans",
method_params = list(max_kmeans_clusters = 5),
# methods = "pam",
# method_params = list(num_clusters = 2),
cover_type = 'stride',
# intervals = 4,
interval_width = 1,
num_cores = 12
)
source('../TDA-R/MapperAlgo/R/Plotter.R')
# `車道劃分設施-分道設施-路面邊線名稱_無 x 當事者區分-類別-大類別名稱-車種_小客車(含客、貨兩用) x cause-group_Decision`
MapperPlotter(Mapper,
label=all_features$hotspot,
data=filter_data,
type="forceNetwork",
avg=TRUE,
use_embedding=FALSE)
plot_data %>%
ggplot(aes(x = value, fill = is_hotspot)) +
geom_histogram(bins = 50, color = "white", alpha = 0.8, position = "stack") +
facet_wrap(~variable, scales = "free") +
# Manual color scale with English labels
scale_fill_manual(values = c("0" = "#999999", "1" = "#E63946"),
name = "Hotspot Status",  labels = c("No", "Yes")) +
theme_minimal() +
labs(title = "Distribution of Variables by Hotspot Status",
subtitle = "Red indicates hotspot occurrences within the value range",
x = "Normalized Value",
y = "Frequency") +
theme(legend.position = "top")
library(tidyverse)
library(igraph)
library(networkD3)
library(ggraph)
library(tidygraph)
library(MapperAlgo)
library(parallel)
library(doParallel)
filter_data <- read_csv("../ST-RTA/ComputedDataV4/ForModel/filtered_dataV1.csv")
filter_data%>%summary()
# all_features <- read_csv("../ST-RTA/ComputedDataV4/ForModel/all_features_gdf.csv")
all_features <- read_csv("../ST-RTA/ComputedDataV4/ForModel/all_features.csv")
all_features$hotspot <- case_when(
all_features$hotspot == 'Not Significant' ~ 0,
TRUE ~ 1
)
all_features <- all_features%>%
mutate(
bn_feature = ifelse(
(
(
(`車道劃分設施-分道設施-路面邊線名稱_無` > 0)
) &
(
(`當事者區分-類別-大類別名稱-車種_小客車(含客、貨兩用)` > 0)
) &
(
(`cause-group_Decision` > 0)
)
),
1,
0
)
)
all_features$bn_feature%>%table()
all_features$`車道劃分設施-分道設施-路面邊線名稱_無 x 當事者區分-類別-大類別名稱-車種_小客車(含客、貨兩用) x cause-group_Decision`
# normalize
n_data <- as.data.frame(scale(filter_data))
n_data%>%summary()
plot_data <- n_data %>%
mutate(is_hotspot = factor(all_features$hotspot)) %>%
pivot_longer(cols = -is_hotspot, names_to = "variable", values_to = "value")
plot_data %>%
ggplot(aes(x = value, fill = is_hotspot)) +
geom_histogram(bins = 50, color = "white", alpha = 0.8, position = "stack") +
facet_wrap(~variable, scales = "free") +
# Manual color scale with English labels
scale_fill_manual(values = c("0" = "#999999", "1" = "#E63946"),
name = "Hotspot Status",  labels = c("No", "Yes")) +
theme_minimal() +
labs(title = "Distribution of Variables by Hotspot Status",
subtitle = "Red indicates hotspot occurrences within the value range",
x = "Normalized Value",
y = "Frequency") +
theme(legend.position = "top")
